{% extends 'base.html' %}

{% block title %}{{ movie.title }} · Tiketa{% endblock %}

{% block extra_head %}
<style>
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 32px;
        margin-bottom: 32px;
    }

    .poster-frame {
        position: relative;
    }

    .poster-frame::after {
        content: "";
        position: absolute;
        inset: 12px;
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.18);
        pointer-events: none;
    }

    .movie-poster-lg {
        width: 100%;
        border-radius: 24px;
        box-shadow: 0 25px 70px rgba(15, 23, 42, 0.55);
        object-fit: cover;
        aspect-ratio: 2 / 3;
    }

    .movie-headline {
        display: grid;
        gap: 18px;
    }

    .movie-title {
        font-size: clamp(2rem, 4vw, 2.8rem);
        font-weight: 600;
        margin: 0;
    }

    .movie-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        color: rgba(226, 232, 240, 0.75);
    }

    .movie-description {
        color: var(--text-secondary);
        line-height: 1.7;
        font-size: 1.05rem;
    }

    .genre-tags {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        column-gap: 10px;
        row-gap: 8px;
        align-items: center;
    }

    .trailer-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
    }
    .trailer-actions .btn {
        padding: 20px 28px;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .trailer-actions .btn .fa-play {
        font-size: 1.5rem;
    }
    .trailer-actions .btn i {
        margin-right: 8px;
    }

    .showtimes-card {
        display: grid;
        gap: 18px;
    }

    .showtime-day {
        display: grid;
        gap: 14px;
    }

    .showtime-date {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        letter-spacing: 0.01em;
    }

    .showtime-day-list {
        display: grid;
        gap: 12px;
    }

    .showtime-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
        padding: 16px 20px;
        border-radius: 18px;
        border: 1px solid rgba(148, 163, 184, 0.22);
        background: rgba(15, 23, 42, 0.62);
    }

    .showtime-time {
        font-weight: 600;
        font-size: 1.1rem;
        letter-spacing: 0.04em;
    }

    .showtime-meta {
        color: rgba(226, 232, 240, 0.7);
        font-size: 0.95rem;
    }

    .trailer-modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 32px;
        background: rgba(5, 8, 21, 0.86);
        backdrop-filter: blur(12px);
        z-index: 1400;
    }

    .trailer-modal.is-visible {
        display: flex;
    }

    .trailer-modal__dialog {
        position: relative;
        width: min(90vw, 760px);
        background: rgba(15, 23, 42, 0.94);
        border-radius: 22px;
        border: 1px solid rgba(148, 163, 184, 0.28);
        box-shadow: 0 40px 90px rgba(5, 8, 21, 0.6);
        overflow: hidden;
    }

    .video-container {
        position: relative;
        width: 100%;
        padding-bottom: 56.25%;
        background: #000;
    }

    .video-container iframe {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        border: 0;
        display: block;
    }

    .trailer-modal__close {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 38px;
        height: 38px;
        border-radius: 50%;
        border: 1px solid rgba(148, 163, 184, 0.3);
        background: rgba(15, 23, 42, 0.78);
        color: var(--text);
        font-size: 1.2rem;
        cursor: pointer;
        display: grid;
        place-items: center;
        transition: transform 0.2s ease, background 0.2s ease;
    }

    .trailer-modal__close:hover {
        transform: scale(1.05);
        background: rgba(124, 58, 237, 0.28);
    }

    body.modal-open {
        overflow: hidden;
    }

    .back-link {
        margin-bottom: 22px;
    }

    @media (max-width: 640px) {
        .showtime-item {
            flex-direction: column;
            align-items: flex-start;
        }

        .showtime-item .btn {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="back-link">
    <a href="{{ url_for('movies.index') }}" class="btn btn-ghost">← Kembali ke Halaman Awal</a>
</div>

<section class="card card-padding detail-grid">
    {% if movie.poster_path %}
        <div class="poster-frame">
            <img src="{{ movie.poster_path }}" alt="Poster of {{ movie.title }}" class="movie-poster-lg">
        </div>
    {% endif %}
    <div class="movie-headline">
        <div>
            <h2 class="movie-title">{{ movie.title }}</h2>
            <div class="movie-meta">
                <span class="badge">Studio {{ '%02d'|format(movie.studio_number) }}</span>
                {% if movie.release_date %}
                    <span>Released {{ movie.release_date.strftime('%B %d, %Y') }}</span>
                {% endif %}
                {% set daily_slots = 6 if movie.studio_number % 2 == 0 else 5 %}
                <span>{{ daily_slots }} shows daily ({{ 'Even' if movie.studio_number % 2 == 0 else 'Odd' }} studio)</span>
            </div>
        </div>
        <p class="movie-description">{{ movie.description }}</p>
        {% if movie.genres %}
            <div class="genre-tags">
                {% for genre in movie.genres %}
                    <span class="tag">{{ genre.name }}</span>
                {% endfor %}
            </div>
        {% endif %}
        {% if movie.trailer_youtube_id %}
            <div class="trailer-actions">
                <button type="button" class="btn btn-secondary" data-trailer-open>
                    <i class="fa-solid fa-play" aria-hidden="true"></i>
                    <span>Lihat Trailer</span>
                </button>
            </div>
        {% endif %}
    </div>
</section>

<section class="card card-padding showtimes-card">
    <div class="section-title">Available Showtimes</div>
    {% if grouped_showtimes %}
        {% for show_date, showtimes in grouped_showtimes.items() %}
            <div class="showtime-day">
                <h3 class="showtime-date">{{ show_date.strftime('%A, %d %B %Y') }}</h3>
                <div class="showtime-day-list">
                    {% for showtime in showtimes %}
                        <div class="showtime-item">
                            <div>
                                <div class="showtime-time">{{ showtime.local_start.strftime('%H:%M') }}</div>
                                <div class="showtime-meta">
                                    Studio {{ '%02d'|format(movie.studio_number) }} · Duration 2h · Ends {{ showtime.local_end.strftime('%H:%M') }}
                                </div>
                            </div>
                            <a href="{{ url_for('movies.book_ticket', showtime_id=showtime.id) }}" class="btn btn-primary">Booking sekarang</a>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <p style="color: var(--text-secondary);">No showtimes available for this movie.</p>
    {% endif %}
</section>

{% if movie.trailer_youtube_id %}
<div class="trailer-modal" data-trailer-modal aria-hidden="true">
    <div class="trailer-modal__dialog" role="dialog" aria-modal="true" aria-label="Trailer">
        <button type="button" class="trailer-modal__close" data-trailer-close aria-label="Tutup trailer">×</button>
        <div class="video-container">
            <iframe
                data-trailer-src="https://www.youtube.com/embed/{{ movie.trailer_youtube_id }}?autoplay=1&rel=0"
                title="Trailer {{ movie.title }}"
                allow="autoplay; encrypted-media"
                allowfullscreen
            ></iframe>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.querySelector('[data-trailer-modal]');
        const trigger = document.querySelector('[data-trailer-open]');

        if (!modal || !trigger) {
            return;
        }

        const iframe = modal.querySelector('iframe');
        const closeButtons = modal.querySelectorAll('[data-trailer-close]');
        const videoSrc = iframe ? iframe.dataset.trailerSrc : null;

        const openModal = () => {
            modal.classList.add('is-visible');
            modal.setAttribute('aria-hidden', 'false');
            if (iframe && videoSrc) {
                iframe.src = videoSrc;
            }
            document.body.classList.add('modal-open');
        };

        const closeModal = () => {
            modal.classList.remove('is-visible');
            modal.setAttribute('aria-hidden', 'true');
            if (iframe) {
                iframe.src = '';
            }
            document.body.classList.remove('modal-open');
        };

        trigger.addEventListener('click', openModal);
        closeButtons.forEach(button => button.addEventListener('click', closeModal));

        modal.addEventListener('click', function (event) {
            if (event.target === modal) {
                closeModal();
            }
        });

        document.addEventListener('keydown', function (event) {
            if (event.key === 'Escape' && modal.classList.contains('is-visible')) {
                closeModal();
            }
        });
    });
</script>
{% endif %}
{% endblock %}